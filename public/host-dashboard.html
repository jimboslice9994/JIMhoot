<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Host Dashboard | Family Learning Game</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              partyBlue: '#3B82F6',
              partyPink: '#EC4899',
              partyPurple: '#8B5CF6',
              partyMint: '#10B981'
            },
            boxShadow: {
              bubble: '0 20px 40px rgba(59,130,246,0.18)'
            }
          }
        }
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-sky-100 via-fuchsia-100 to-emerald-100 text-slate-800">
    <main class="mx-auto max-w-6xl p-6 md:p-10">
      <header class="mb-6 rounded-3xl bg-white/90 p-6 shadow-bubble backdrop-blur">
        <h1 class="text-3xl font-black tracking-tight text-partyPurple md:text-4xl">üéâ Host Dashboard</h1>
        <p class="mt-2 text-sm text-slate-600 md:text-base">
          Upload your class CSV, share the room instantly with QR, and unlock AI dog rewards at milestones.
        </p>
      </header>

      <section class="grid gap-6 lg:grid-cols-2">
        <article class="rounded-3xl bg-white/90 p-6 shadow-bubble backdrop-blur">
          <div class="mb-4 flex items-center gap-2">
            <i data-lucide="file-up" class="h-6 w-6 text-partyBlue"></i>
            <h2 class="text-xl font-bold">Upload CSV</h2>
          </div>
          <p class="mb-4 text-sm text-slate-600">Required columns: <strong>Subject, Question, Options, CorrectAnswer</strong></p>

          <div class="flex flex-wrap items-center gap-3">
            <label for="csvFile" class="cursor-pointer rounded-2xl bg-partyBlue px-4 py-2 font-semibold text-white transition hover:brightness-110">
              Choose CSV
            </label>
            <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
            <span id="fileStatus" class="text-sm text-slate-500">No file selected</span>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="parseCsvBtn" class="rounded-2xl bg-partyPink px-4 py-2 font-semibold text-white transition hover:brightness-110">
              Parse Course Data
            </button>
            <button id="clearCsvBtn" class="rounded-2xl border border-slate-300 px-4 py-2 font-semibold text-slate-700 hover:bg-slate-100">
              Clear
            </button>
          </div>

          <p id="csvSummary" class="mt-4 text-sm text-slate-700"></p>

          <div class="mt-4 max-h-80 overflow-auto rounded-2xl border border-slate-200">
            <table class="min-w-full text-left text-sm">
              <thead class="sticky top-0 bg-slate-100 text-slate-700">
                <tr>
                  <th class="px-3 py-2">Subject</th>
                  <th class="px-3 py-2">Question</th>
                  <th class="px-3 py-2">Options</th>
                  <th class="px-3 py-2">Correct</th>
                </tr>
              </thead>
              <tbody id="csvTableBody" class="bg-white"></tbody>
            </table>
          </div>
        </article>

        <article class="space-y-6">
          <section class="rounded-3xl bg-white/90 p-6 shadow-bubble backdrop-blur">
            <div class="mb-4 flex items-center gap-2">
              <i data-lucide="qr-code" class="h-6 w-6 text-partyMint"></i>
              <h2 class="text-xl font-bold">Scan to Join</h2>
            </div>

            <div class="grid gap-4 md:grid-cols-[1fr_auto] md:items-start">
              <div>
                <p class="text-sm text-slate-600">Room ID</p>
                <p id="roomIdText" class="text-3xl font-black tracking-widest text-partyPurple">-----</p>
                <p class="mt-1 text-xs text-slate-500">Share this Room ID or have players scan the QR code.</p>

                <div class="mt-4 flex gap-3">
                  <button id="generateRoomBtn" class="rounded-2xl bg-partyPurple px-4 py-2 font-semibold text-white transition hover:brightness-110">
                    Generate Room ID
                  </button>
                  <button id="copyJoinLinkBtn" class="rounded-2xl border border-slate-300 px-4 py-2 font-semibold text-slate-700 hover:bg-slate-100">
                    Copy Join Link
                  </button>
                </div>
                <p id="joinLinkText" class="mt-3 break-all text-xs text-slate-500"></p>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-white p-3">
                <div id="qrCanvas" class="h-[180px] w-[180px]"></div>
              </div>
            </div>
          </section>

          <section class="rounded-3xl bg-white/90 p-6 shadow-bubble backdrop-blur">
            <div class="mb-4 flex items-center gap-2">
              <i data-lucide="award" class="h-6 w-6 text-amber-500"></i>
              <h2 class="text-xl font-bold">AI Dog Reward Generator</h2>
            </div>

            <div class="grid gap-3 md:grid-cols-2">
              <label class="text-sm font-semibold text-slate-700">Milestone Name
                <input id="milestoneInput" value="1000 XP" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
              </label>
              <label class="text-sm font-semibold text-slate-700">Dog Theme Prompt
                <input id="dogPromptInput" value="Golden Retriever Scientist" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
              </label>
            </div>

            <label class="mt-3 block text-sm font-semibold text-slate-700">OpenAI API Key (optional, for real calls)
              <input id="apiKeyInput" type="password" placeholder="sk-..." class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
            </label>

            <button id="generateDogBtn" class="mt-4 rounded-2xl bg-partyMint px-4 py-2 font-semibold text-white transition hover:brightness-110">
              Generate Dog Reward Image
            </button>

            <p id="rewardStatus" class="mt-3 text-sm text-slate-600"></p>
            <img id="rewardImage" alt="Generated AI dog reward" class="mt-3 hidden w-full max-w-md rounded-2xl border border-slate-200 object-cover" />
          </section>
        </article>
      </section>
    </main>

    <script>
      lucide.createIcons();

      const state = {
        parsedRows: [],
        roomId: '',
        joinUrl: '',
        qrCode: null,
      };

      const csvFile = document.getElementById('csvFile');
      const fileStatus = document.getElementById('fileStatus');
      const csvSummary = document.getElementById('csvSummary');
      const csvTableBody = document.getElementById('csvTableBody');
      const parseCsvBtn = document.getElementById('parseCsvBtn');
      const clearCsvBtn = document.getElementById('clearCsvBtn');
      const roomIdText = document.getElementById('roomIdText');
      const generateRoomBtn = document.getElementById('generateRoomBtn');
      const copyJoinLinkBtn = document.getElementById('copyJoinLinkBtn');
      const joinLinkText = document.getElementById('joinLinkText');
      const qrCanvas = document.getElementById('qrCanvas');
      const generateDogBtn = document.getElementById('generateDogBtn');
      const rewardStatus = document.getElementById('rewardStatus');
      const rewardImage = document.getElementById('rewardImage');

      csvFile.addEventListener('change', () => {
        fileStatus.textContent = csvFile.files?.[0]?.name || 'No file selected';
      });

      parseCsvBtn.addEventListener('click', () => {
        const file = csvFile.files?.[0];
        if (!file) {
          csvSummary.textContent = 'Please choose a CSV file first.';
          return;
        }

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete(results) {
            const requiredColumns = ['Subject', 'Question', 'Options', 'CorrectAnswer'];
            const headers = results.meta.fields || [];
            const missing = requiredColumns.filter((col) => !headers.includes(col));
            if (missing.length) {
              csvSummary.textContent = `Missing required columns: ${missing.join(', ')}`;
              csvTableBody.innerHTML = '';
              state.parsedRows = [];
              return;
            }

            state.parsedRows = results.data.map((row) => ({
              Subject: String(row.Subject || '').trim(),
              Question: String(row.Question || '').trim(),
              Options: String(row.Options || '').trim(),
              CorrectAnswer: String(row.CorrectAnswer || '').trim(),
            })).filter((row) => row.Question);

            csvSummary.textContent = `Loaded ${state.parsedRows.length} questions successfully.`;
            renderCsvRows(state.parsedRows);
          },
          error(err) {
            csvSummary.textContent = `CSV parse failed: ${err.message}`;
          }
        });
      });

      clearCsvBtn.addEventListener('click', () => {
        csvFile.value = '';
        fileStatus.textContent = 'No file selected';
        csvSummary.textContent = '';
        csvTableBody.innerHTML = '';
        state.parsedRows = [];
      });

      function renderCsvRows(rows) {
        csvTableBody.innerHTML = rows.slice(0, 30).map((row) => `
          <tr class="border-b border-slate-100 align-top">
            <td class="px-3 py-2">${escapeHtml(row.Subject)}</td>
            <td class="px-3 py-2">${escapeHtml(row.Question)}</td>
            <td class="px-3 py-2">${escapeHtml(row.Options)}</td>
            <td class="px-3 py-2 font-semibold">${escapeHtml(row.CorrectAnswer)}</td>
          </tr>
        `).join('');
      }

      function generateRoomId() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
      }

      generateRoomBtn.addEventListener('click', () => {
        state.roomId = generateRoomId();
        state.joinUrl = `${window.location.origin}/#/join?room=${encodeURIComponent(state.roomId)}`;

        roomIdText.textContent = state.roomId;
        joinLinkText.textContent = state.joinUrl;
        qrCanvas.innerHTML = '';

        state.qrCode = new QRCode(qrCanvas, {
          text: state.joinUrl,
          width: 180,
          height: 180,
          colorDark: '#111827',
          colorLight: '#FFFFFF',
          correctLevel: QRCode.CorrectLevel.H,
        });
      });

      copyJoinLinkBtn.addEventListener('click', async () => {
        if (!state.joinUrl) {
          joinLinkText.textContent = 'Generate a room first, then copy the link.';
          return;
        }
        try {
          await navigator.clipboard.writeText(state.joinUrl);
          joinLinkText.textContent = `Copied: ${state.joinUrl}`;
        } catch {
          joinLinkText.textContent = `Copy blocked by browser. Manually copy: ${state.joinUrl}`;
        }
      });

      generateDogBtn.addEventListener('click', async () => {
        const milestone = document.getElementById('milestoneInput').value.trim() || 'Milestone';
        const dogPrompt = document.getElementById('dogPromptInput').value.trim() || 'Golden Retriever Scientist';
        const apiKey = document.getElementById('apiKeyInput').value.trim();

        rewardStatus.textContent = 'Generating your reward dog image...';
        rewardImage.classList.add('hidden');

        try {
          const imageUrl = await generateDogRewardImage({ milestone, dogPrompt, apiKey });
          rewardImage.src = imageUrl;
          rewardImage.classList.remove('hidden');
          rewardStatus.textContent = `Reward unlocked for ${milestone}! üèÜ`;
        } catch (error) {
          rewardStatus.textContent = `Failed to generate image: ${error.message}`;
        }
      });

      /**
       * Placeholder AI image function.
       * Plug in your API key and keep this pattern for OpenAI Images API.
       */
      async function generateDogRewardImage({ milestone, dogPrompt, apiKey }) {
        const prompt = `${dogPrompt}, celebratory educational sticker art, confetti, badge, milestone: ${milestone}`;

        if (!apiKey) {
          return `https://placehold.co/1024x1024/png?text=${encodeURIComponent(`Reward: ${dogPrompt}`)}`;
        }

        const response = await fetch('https://api.openai.com/v1/images/generations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: 'gpt-image-1',
            prompt,
            size: '1024x1024',
          }),
        });

        if (!response.ok) {
          const detail = await response.text();
          throw new Error(`OpenAI API error (${response.status}): ${detail}`);
        }

        const data = await response.json();
        const b64 = data?.data?.[0]?.b64_json;
        const url = data?.data?.[0]?.url;
        if (url) return url;
        if (b64) return `data:image/png;base64,${b64}`;
        throw new Error('No image returned from API');
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }
    </script>
  </body>
</html>
